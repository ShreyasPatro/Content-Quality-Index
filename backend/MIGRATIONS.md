# Database Migrations with Alembic

This project uses Alembic for database schema migrations with async SQLAlchemy Core.

## Migration Workflow

### Initial Setup

The database schema is defined in `01_architecture/schema.sql`. To initialize the database:

1. **Create the database:**
   ```bash
   createdb content_quality_engine
   ```

2. **Apply the schema directly:**
   ```bash
   psql -d content_quality_engine -f ../01_architecture/schema.sql
   ```

3. **Initialize Alembic version tracking:**
   ```bash
   alembic stamp head
   ```

### Creating Migrations

Migrations are **manually written** (not autogenerated) to maintain explicit control over schema changes.

**Create a new migration:**
```bash
alembic revision -m "description_of_change"
```

This creates a new file in `alembic/versions/` with `upgrade()` and `downgrade()` functions.

**Example migration:**
```python
"""Add approval_states.notes column

Revision ID: abc123
Revises: def456
Create Date: 2026-01-28 12:00:00

"""
from alembic import op
import sqlalchemy as sa

revision = 'abc123'
down_revision = 'def456'

def upgrade() -> None:
    op.execute("ALTER TABLE approval_states ADD COLUMN notes TEXT")

def downgrade() -> None:
    op.execute("ALTER TABLE approval_states DROP COLUMN notes")
```

### Applying Migrations

**Upgrade to latest:**
```bash
alembic upgrade head
```

**Upgrade by one version:**
```bash
alembic upgrade +1
```

**Downgrade by one version:**
```bash
alembic downgrade -1
```

**View current version:**
```bash
alembic current
```

**View migration history:**
```bash
alembic history --verbose
```

### Migration Best Practices

1. **Write explicit SQL** - Use `op.execute()` for DDL statements
2. **Test downgrades** - Always test `downgrade()` functions
3. **One change per migration** - Keep migrations focused
4. **Never modify applied migrations** - Create new migrations for changes
5. **Include data migrations** - Use `op.execute()` for data transformations

### Example: Adding a Table

```python
def upgrade() -> None:
    op.execute("""
        CREATE TABLE fast_approvals (
            id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
            approval_id UUID NOT NULL REFERENCES approval_states(id),
            reviewer_id UUID NOT NULL REFERENCES users(id),
            review_duration_seconds NUMERIC(10, 2) NOT NULL,
            flagged_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
        )
    """)
    op.execute("CREATE INDEX idx_fast_approvals_reviewer ON fast_approvals(reviewer_id)")

def downgrade() -> None:
    op.execute("DROP TABLE fast_approvals")
```

### Async Support

Alembic is configured to work with async SQLAlchemy Core:
- Uses `asyncpg` driver
- Loads database URL from `app.core.config.settings`
- Runs migrations in async context

### Troubleshooting

**"Target database is not up to date"**
```bash
alembic stamp head
```

**"Can't locate revision"**
```bash
alembic history
alembic stamp <revision_id>
```

**Reset migrations (DANGER - development only)**
```bash
# Drop all tables
psql -d content_quality_engine -c "DROP SCHEMA public CASCADE; CREATE SCHEMA public;"
# Reapply schema
psql -d content_quality_engine -f ../01_architecture/schema.sql
# Reset Alembic
alembic stamp head
```

## Configuration

- `alembic.ini` - Alembic configuration
- `alembic/env.py` - Migration environment (async-compatible)
- `alembic/versions/` - Migration files (versioned)
